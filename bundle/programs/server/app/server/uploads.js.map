{"version":3,"sources":["meteor://ðŸ’»app/server/uploads.js"],"names":[],"mappings":"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","file":"/server/uploads.js","sourcesContent":["// Upload files with tomitrescak:meteor-uploads\n\nMeteor.startup(function () {\n\n\tUploadServer.init({\n\t\ttmpDir: Meteor.settings.uploadDir+'/tmp',\n\t\tuploadDir: Meteor.settings.uploadDir,\n\t\tcheckCreateDirectories: true,\n\t\tgetDirectory: function(fileInfo, formData) {\n\n\t\t\tvar spaceId = formData.spaceId;\n\t\t\tfileInfo.spaceId = spaceId;\n\n\t\t\tvar newID = new Mongo.ObjectID(); // Manually generate a new Mongo id\n\t\t\tvar fileId = newID._str;\n\t\t\tfileInfo.fileId = fileId;\n\n\t\t\tif (formData.type == 'liveFeed') {\n\t\t\t\tconsole.log(\"Uploading a liveFeed file...\");\n\t\t\t\treturn '/'+spaceId+'/liveFeed/';\n\t\t\t}\n\t\t\telse if (formData.type == 'resource') {\n\t\t\t\tconsole.log(\"Uploading a resource...\");\n\t\t\t\treturn '/'+spaceId+'/resource/';\n\t\t\t}\n\t\t\telse if (formData.type == 'lesson') {\n\t\t\t\tconsole.log(\"Uploading lesson file...\");\n\t\t\t\treturn '/'+spaceId+'/lesson/'+fileId;\n\t\t\t}\n\t\t\t// TODO : add more security\n\t\t\telse if (formData.type == 'update') {\n\t\t\t\tconsole.log(\"Uploading update file\");\n\t\t\t\treturn '/updates';\n\t\t\t}\n\t\t\treturn '/';\n\t\t\t\n\t\t},\n\t\tfinished: function(fileInfo, formFields, formData) {\n\n\t\t\tvar fileName = fileInfo.name.substr(0, fileInfo.name.lastIndexOf('.')) || fileInfo.name;\n\t\t\tfileInfo.fileName = fileName;\n\t\t\t//fileInfo.fileName = unescape(fileName); // Check why we unescape file name in getFileName method\n\n\t\t\tvar fileExt = fileInfo.name.substr(fileInfo.name.lastIndexOf('.')+1).toLowerCase();\n\t\t\tfileInfo.fileExt = fileExt;\n\n\t\t\tif (formFields.type == 'liveFeed' || formFields.type == 'resource') {\n\t\t\t\tif (fileExt == \"jpg\" || fileExt == \"jpeg\" || fileExt == \"png\") {\n\t\t\t\t\t// Resize and auto-orient uploaded images with GraphicMagicks\n\t\t\t\t\tgm(Meteor.settings.uploadDir+fileInfo.path).autoOrient().resize('1200','1200').write(Meteor.settings.uploadDir+fileInfo.path,Meteor.bindEnvironment(function (error, result) {\n\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\tconsole.log(\"Error when resizing :\"+error);\n\t\t\t\t\t\t\tvar errorMessage = \"An error has occured.\"\n\t\t\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, error:errorMessage});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, fileName:fileInfo.fileName, fileExt:fileExt, filePath: fileInfo.path});\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, fileName:fileInfo.fileName, fileExt:fileExt, filePath: fileInfo.path});\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (formFields.type == 'lesson') {\n\t\t\t\tcmd = Meteor.wrapAsync(exec);\n\t\t\t\tres = cmd(\"unzip '\"+Meteor.settings.uploadDir+fileInfo.path+\"' -d '\"+Meteor.settings.uploadDir+\"/\"+fileInfo.spaceId+\"/lesson/\"+fileInfo.fileId+\"'\", {maxBuffer : 1024 * 1024 * 64}, function(error,result){\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\tconsole.log(\"Error when uploading a lesson : \"+error);\n\t\t\t\t\t\tvar errorMessage = \"An error has occured.\"\n\t\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, error:errorMessage});\n\t\t\t\t\t} else {\t\t\t\t\n\t\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, fileName:fileInfo.fileName, fileExt:fileExt, filePath: fileInfo.path})\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tres2 = cmd(\"rm '\"+Meteor.settings.uploadDir+fileInfo.path+\"'\");\n\t\t\t}\n\t\t\telse if (formFields.type == 'update') {\n\t\t\t\tcmd = Meteor.wrapAsync(exec);\t\n\t\t\t\tres = cmd(\"tar zxvf '\"+Meteor.settings.uploadDir+fileInfo.path+\"' -C \"+Meteor.settings.updateDir, {maxBuffer : 1024 * 1024 * 64}, function(error,result){\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\tconsole.log(\"Error when uploading an update : \"+error);\n\t\t\t\t\t\tvar errorMessage = \"An error has occured.\"\n\t\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, error:errorMessage});\n\t\t\t\t\t} else {\t\t\t\t\n\t\t\t\t\t\tFiles.insert({_id: fileInfo.fileId, fileName:fileInfo.fileName, fileExt:fileExt, filePath: fileInfo.path})\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tres2 = cmd(\"rm '\"+Meteor.settings.uploadDir+fileInfo.path+\"'\", {maxBuffer : 1024 * 1024 * 64},);\n\t\t\t}\n\t\t},\n\t\tgetFileName: function(fileInfo, formFields, formData) { \n\n\t\t\tvar fileName = fileInfo.name;\t\n\n\t\t\t//fileName = escape(fileName);\n\t\t\t// The file name is used to generate the file path, so we escape unicode characters\n\t\t\t// and then we unescape it in finished method to save it in human-readable text\n\n\t\t\treturn fileName;\n\t\t\t// var fileExt = fileInfo.name.substr(fileInfo.name.lastIndexOf('.')+1).toLowerCase();\n\n\t\t\t// // If file is an image, set a random name\n\t\t\t// if (fileExt == \"jpg\" || fileExt == \"jpeg\" || fileExt == \"png\") {\n\t\t\t// \tvar newName = Random.id() + '.' + fileExt;\n\t\t\t// \treturn newName;\n\t\t\t// }\n\t\t\t// else {\n\t\t\t// \tvar fileName = fileInfo.name;\t\n\n\t\t\t// \tfileName = encodeURIComponent(fileName);\n\n\t\t\t// \treturn fileName;\n\t\t\t// }\n\t\t},\n\t\tcacheTime: 0,\n  \t});\n});"]}